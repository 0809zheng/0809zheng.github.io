---
layout: post
title: 'MPDIoU: A Loss for Efficient and Accurate Bounding Box Regression'
date: 2023-07-14
author: 郑之杰
cover: 'https://pic.imgdb.cn/item/64c07c2d1ddac507cc468797.jpg'
tags: 论文阅读
---

> MPDIoU：一种高效且准确的边界框回归损失.

- paper：[MPDIoU: A Loss for Efficient and Accurate Bounding Box Regression](https://arxiv.org/abs/2307.07662)

边界框回归（**Bounding Box Regression**）在目标检测和实例分割中被广泛应用，是定位目标的重要步骤。然而，大多数现有的边界框回归损失函数在预测框与实际标注框具有相同的宽高比但宽度和高度值完全不同的情况下无法进行优化。

为了解决上述问题，作者充分探索了水平矩形的几何特征，提出了一种基于最小点距离（**minimum point distance, MPD**）的边界框相似度比较度量：**MPDIoU**，其中包含了现有损失函数中考虑的所有相关因素，例如重叠或非重叠面积、中心点距离以及宽度和高度的偏差，同时简化了计算过程。在此基础上，作者提出了一种基于**MPDIoU**的边界框回归损失函数，称为**MPDIoU Loss**。

# 1. MPDIoU

通常情况下，使用左上角和右下角点的坐标来定义一个唯一的矩形。受到边界框几何特性的启发，作者设计了一种新颖的基于交并比的度量标准，名为**MPDIoU**，直接最小化预测边界框与实际标注边界框之间的左上角和右下角点距离。

$$ \text{MPDIoU} = \text{IoU} - \frac{d_1^2}{w^2+h^2}- \frac{d_2^2}{w^2+h^2} $$

![](https://pic.imgdb.cn/item/64c07dab1ddac507cc48af59.jpg)

**MPDIoU**简化了两个边界框之间的相似性比较，适用于重叠或非重叠的边界框回归。由于现有损失函数中考虑的因素都可以通过左上角点和右下角点的坐标来确定，例如非重叠面积、中心点距离、宽度和高度的偏差，这意味着**MPDIoU**不仅考虑全面，还简化了计算过程。

相比于现有的**IoU**系列指标，**MPDIoU**在下面这种情况下是最优的：假设对于某个真实框$(w_{gt},h_{gt})$，存在两个中心重合的检测框$(kw_{gt},kh_{gt}),(w_{gt}/k,h_{gt}/k)$：

![](https://pic.imgdb.cn/item/64c09d131ddac507cc7fb012.jpg)

现有的**IoU**系列指标对上述两框的评估值是完全相同的；对于**MPDIoU**，预测边界框位于真实标注边界框内的值低于预测边界框位于真实标注边界框外的情况。这一特性保证了边界框回归的准确性，倾向于提供具有较少冗余的预测边界框。

$$
\begin{aligned}
& \text{∵} \operatorname{IoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)=\frac{w_{g t} * h_{g t}}{w_{p r d 1} * h_{p r d 1}}=\frac{w_{g t} * h_{g t}}{k * w_{g t} * k * h_{g t}}=\frac{1}{k^2}, \\
& \operatorname{IoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)=\frac{w_{p r d 2} * h_{p r d 2}}{w_{g t} * h_{g t}}=\frac{\frac{1}{k} * w_{g t} * \frac{1}{k} * h_{g t}}{w_{g t} * h_{g t}}=\frac{1}{k^2} \\
& \text{∴} \operatorname{IoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)=\operatorname{IoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right) \\
& \text{∵} \text{The central points of the } \mathcal{B}_{g t}, \mathcal{B}_{p r d 1} \text{ and } \mathcal{B}_{p r d 2} \text{ are all overlap} \\
& \text{∴} \operatorname{GIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)=\operatorname{GIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)=\operatorname{DIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)=\operatorname{DIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right) =\frac{1}{k^2}\\
& \text{∵}  \operatorname{CIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)=\operatorname{IoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)-\frac{\left(\frac{4}{\pi^2}\left(\arctan \frac{w_{g t}}{h_g}-\arctan \frac{w^{p r d 1}}{h^{p r d 1}}\right)^2\right)^2}{1-\frac{1}{k^2}+\frac{4}{\pi^2}\left(\arctan \frac{w_{g t}}{h_{g t}}-\arctan \frac{w^{p r d 1}}{h^{p r d 1}}\right)^2}=\frac{1}{k^2}-\frac{\left(\frac{4}{\pi^2}\left(\arctan \frac{w_{g t}}{h_{g t}}-\arctan \frac{k * w_{g t}}{k * h_{g t}}\right)^2\right)^2}{1-\frac{1}{k^2}+\frac{4}{\pi^2}\left(\arctan \frac{w_{g t}}{h_{g t}}-\arctan \frac{k * w_{g t}}{k * h_{g t}}\right)^2}=\frac{1}{k^2} . \\
&   \operatorname{CIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)=\operatorname{IoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)-\frac{\left(\frac{4}{\pi^2}\left(\arctan \frac{w_{g t}}{h_g}-\arctan \frac{w^{p r d 2}}{h^{p r d 2}}\right)^2\right)^2}{1-\frac{1}{k^2}+\frac{4}{\pi^2}\left(\arctan \frac{w_{g t}}{h_{g t}}-\arctan \frac{w^{p r d 2}}{h^{p r d 2}}\right)^2}=\frac{1}{k^2}-\frac{\left(\frac{4}{\pi^2}\left(\arctan \frac{w_{g t}}{h_{g t}}-\arctan \frac{\frac{1}{k} * w_{g t}}{\frac{1}{k} * h_{g t}}\right)^2\right)^2}{1-\frac{1}{k^2}+\frac{4}{\pi^2}\left(\arctan \frac{w_{g t}}{h_{g t}}-\arctan \frac{\frac{1}{k} * w_{g t}}{\frac{1}{k} * h_{g t}}\right)^2}=\frac{1}{k^2} . \\
& \text{∴} \operatorname{CIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{\text {prd1 }}\right)=\operatorname{CIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{\text {prd } 2}\right) \text {. } \\
& \text{∵} \operatorname{EIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)=\operatorname{DIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)-\frac{\left(w_{p r d 1}-w_{g t}\right)^2}{w_{p r d 1}^2}-\frac{\left(h_{p r d 1}-h_{g t}\right)^2}{h_{p r d 1}^2}=\frac{1}{k^2}-\frac{\left(k * w_{g t}-w_{g t}\right)^2}{k^2 * w_{g t}^2}-\frac{\left(k * h_{g t}-h_{g t}\right)^2}{k^2 * h_{g t}^2}=\frac{4 * k-2 * k^2-1}{k^2} \\
& \operatorname{EIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)=\operatorname{DIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)-\frac{\left(w_{g t}-w_{p r d 2}\right)^2}{w_{g t}^2}-\frac{\left(h_{g t}-h_{p r d 2}\right)^2}{h_{g t}^2}=\frac{1}{k^2}-\frac{\left(w_{g t}-\frac{1}{k} w_{g t}\right)^2}{w_{g t}^2}-\frac{\left(h_{g t}-\frac{1}{k} h_{g t}\right)^2}{h_{g t}^2}=\frac{4 * k-2 * k^2-1}{k^2} \text {. } \\
& \text{∴} \operatorname{EIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)=\operatorname{EIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right) \text {. } \\
& \text{∵} \operatorname{MPDIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)=\operatorname{IoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)-\frac{\left(x_1^{p r d 1}-x_1^{g t}\right)^2+\left(y_1^{p r d 1}-y_1^{g t}\right)^2+\left(x_2^{p r d 1}-x_2^{g t}\right)^2+\left(y_2^{p r d 1}-y_2^{g t}\right)^2}{w^2+h^2}=\frac{1}{k^2}-\frac{2 *\left(\left(\frac{1}{2} * k * w_{g t}-\frac{1}{2} * w_{g t}\right)^2+\left(\frac{1}{2} * k * h_{g t}-\frac{1}{2} * h_{g t}\right)^2\right)}{w^2+h^2}, \\
& \operatorname{MPDIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)=\operatorname{IoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)-\frac{\left(x_1^{p r d 2}-x_1^{g t}\right)^2+\left(y_1^{p r d 2}-y_1^{g t}\right)^2+\left(x_2^{p r d 2}-x_2^{g t}\right)^2+\left(y_2^{p r d 2}-y_2^{g t}\right)^2}{w^2+h^2}=\frac{1}{k^2}-\frac{2 *\left(\left(\frac{1}{2} * w_{g t}-\frac{1}{2 k} * w_{g t}\right)^2+\left(\frac{1}{2} * h_{g t}-\frac{1}{2 k} * h_{g t}\right)^2\right)}{w^2+h^2}, \\
& \text{∴} \operatorname{MPDIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 1}\right)-\operatorname{MPDIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{p r d 2}\right)=\frac{1}{4} *(k-1)^2 *\left(w_{g t}^2+h_{g t}^2\right)-\frac{1}{4} *\left(1-\frac{1}{k}\right)^2 *\left(w_{g t}^2+h_{g t}^2\right)= \\
& \frac{1}{4} *\left(w_{g t}^2+h_{g t}^2\right) *\left((k-1)^2-\left(1-\frac{1}{k}\right)^2\right) \\
& \text{∵}(k-1)^2>\left(1-\frac{1}{k}\right)^2 \\
& \text{∴} \operatorname{MPDIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{\text {prd1 }}\right)>\operatorname{MPDIoU}\left(\mathcal{B}_{g t}, \mathcal{B}_{\text {prd } 2}\right) \text {. } \\
\end{aligned}
$$

![](https://pic.imgdb.cn/item/64c0a1731ddac507cc864b82.jpg)

# 2. MPDIoU Loss

通过**MPDIoU**可以定义**MPDIoU loss**：

$$ \text{MPDIoU loss} = 1-\text{MPDIoU} $$

![](https://pic.imgdb.cn/item/64c0a26a1ddac507cc87ac1f.jpg)

**MPDIoU loss**始终有界，取值范围是$[0, 3)$。当两框不重叠时，**MPDIoU loss** $=d_1^2/d^2+d_2^2/d^2$，最小化该损失实际是在最小化两框左上角与右下角之间的距离。
